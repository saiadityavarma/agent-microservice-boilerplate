global:
  resolve_timeout: 5m
  slack_api_url: "${SLACK_WEBHOOK_URL}"
  pagerduty_url: "https://events.pagerduty.com/v2/enqueue"

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    # Critical alerts go to PagerDuty and Slack
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true

    - match:
        severity: critical
      receiver: 'slack-critical'

    # Warning alerts go to Slack only
    - match:
        severity: warning
      receiver: 'slack-warnings'

    # Info alerts go to Slack (low priority)
    - match:
        severity: info
      receiver: 'slack-info'

    # Component-specific routing
    - match:
        component: api
      receiver: 'slack-api-team'

    - match:
        component: worker
      receiver: 'slack-worker-team'

    - match:
        component: database
      receiver: 'slack-database-team'
      routes:
        - match:
            severity: critical
          receiver: 'pagerduty-database'

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # If service is down, don't alert on high latency
  - source_match:
      severity: 'critical'
      alertname: 'AgentServiceDown'
    target_match:
      severity: 'warning'
      component: 'api'
    equal: ['cluster', 'service']

  # If pod is not ready, don't alert on high error rate
  - source_match:
      alertname: 'AgentServicePodNotReady'
    target_match:
      alertname: 'AgentServiceHighErrorRate'
    equal: ['pod', 'namespace']

  # If workers are down, don't alert on high queue depth
  - source_match:
      severity: 'critical'
      alertname: 'CeleryWorkerDown'
    target_match:
      alertname: 'CeleryHighQueueDepth'
    equal: ['cluster']

# Receiver configurations
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts-general'
        title: 'Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Component:* {{ .Labels.component }}
          {{ end }}
        send_resolved: true

  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: "${PAGERDUTY_SERVICE_KEY}"
        severity: 'critical'
        description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          cluster: '{{ .GroupLabels.cluster }}'
          namespace: '{{ .GroupLabels.namespace }}'
        client: 'Prometheus AlertManager'
        client_url: 'https://prometheus.example.com'

  - name: 'slack-critical'
    slack_configs:
      - channel: '#alerts-critical'
        color: 'danger'
        title: ':rotating_light: CRITICAL: {{ .GroupLabels.alertname }}'
        title_link: 'https://grafana.example.com'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Component:* {{ .Labels.component }}
          *Instance:* {{ .Labels.instance }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ end }}
        send_resolved: true
        actions:
          - type: button
            text: 'View in Grafana'
            url: 'https://grafana.example.com/d/agent-service'
          - type: button
            text: 'View Logs'
            url: 'https://logs.example.com'
          - type: button
            text: 'Silence Alert'
            url: 'https://alertmanager.example.com'

  - name: 'slack-warnings'
    slack_configs:
      - channel: '#alerts-warnings'
        color: 'warning'
        title: ':warning: Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Component:* {{ .Labels.component }}
          {{ end }}
        send_resolved: true

  - name: 'slack-info'
    slack_configs:
      - channel: '#alerts-info'
        color: 'good'
        title: ':information_source: Info: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: false

  - name: 'slack-api-team'
    slack_configs:
      - channel: '#team-api-alerts'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'API Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}
        send_resolved: true

  - name: 'slack-worker-team'
    slack_configs:
      - channel: '#team-worker-alerts'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'Worker Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}
        send_resolved: true

  - name: 'slack-database-team'
    slack_configs:
      - channel: '#team-database-alerts'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'Database Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}
        send_resolved: true

  - name: 'pagerduty-database'
    pagerduty_configs:
      - service_key: "${PAGERDUTY_DATABASE_SERVICE_KEY}"
        severity: 'critical'
        description: 'Database Critical: {{ .Annotations.summary }}'

# Time intervals for muting alerts during maintenance windows
time_intervals:
  - name: 'maintenance-windows'
    time_intervals:
      - weekdays: ['saturday', 'sunday']
        times:
          - start_time: '02:00'
            end_time: '06:00'
        location: 'America/New_York'

# Mute routes during maintenance windows
mute_time_intervals:
  - 'maintenance-windows'
